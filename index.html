<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ï¼šç§»åŠ¨ç«¯è§†å£è®¾ç½®ï¼Œç¦æ­¢ç¼©æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MindFlow - åˆ›æ„å‘æ•£</title>
    
    <!-- å¼•å…¥ D3.js (ä½¿ç”¨æ›´ç¨³å®šçš„ CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <!-- å¼•å…¥ Marked (ç”¨äºè§£æ Markdown) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>

    <style>
        :root {
            --bg-color: #ffffff;
            --text-main: #000000;
            --accent-color: #FFD700; /* äº®é»„è‰² */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(0, 0, 0, 0.08);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.05);
        }

        /* å…¨å±€é‡ç½®ï¼Œé˜²æ­¢ç§»åŠ¨ç«¯æ©¡çš®ç­‹æ•ˆæœ */
        html, body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
            width: 100vw;
            height: 100vh; /* å…¼å®¹ */
            height: 100dvh; /* ç§»åŠ¨ç«¯åŠ¨æ€é«˜åº¦ */
            color: var(--text-main);
            touch-action: none; /* ç¦æ­¢é»˜è®¤è§¦æ‘¸è¡Œä¸º */
            -webkit-tap-highlight-color: transparent;
        }

        /* åŠ è½½ä¸­æç¤º (é˜²æ­¢ç™½å±) */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: #666;
            transition: opacity 0.5s;
        }

        /* ç”»å¸ƒåŒºåŸŸ */
        #viz-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 1;
        }

        /* ç»ç’ƒè´¨æ„Ÿé€šç”¨ç±» */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
        }

        /* è¾“å…¥æ¡†å®¹å™¨ */
        #input-wrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            z-index: 10;
            transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* æ¿€æ´»åç§»åŠ¨åˆ°åº•éƒ¨ï¼Œé€‚é… iPhone å®‰å…¨åŒºåŸŸ */
        #input-wrapper.active {
            top: auto;
            bottom: 30px;
            bottom: calc(30px + env(safe-area-inset-bottom)); /* é€‚é… iPhone X+ */
            transform: translate(-50%, 0);
        }

        #main-input {
            width: 100%;
            height: 50px;
            border-radius: 50px;
            border: 1px solid rgba(0,0,0,0.1);
            padding: 0 20px;
            font-size: 16px; /* é˜²æ­¢ iOS è¾“å…¥æ¡†æ”¾å¤§ */
            outline: none;
            transition: all 0.3s;
            text-align: center;
            background: rgba(255,255,255,0.9);
            box-sizing: border-box;
            appearance: none; /* ç§»é™¤iOSé»˜è®¤æ ·å¼ */
        }

        #main-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }

        /* å³ä¸Šè§’åŠŸèƒ½åŒº */
        .top-right-controls {
            position: absolute;
            top: 20px;
            top: calc(20px + env(safe-area-inset-top));
            right: 20px;
            z-index: 20;
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* ä¾§è¾¹æ ï¼šç§»åŠ¨ç«¯è®¾ä¸ºå…¨å±æˆ–å®½å¹… */
        .sidebar {
            position: absolute;
            right: -100%;
            top: 0;
            width: 100%;
            max-width: 320px;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            z-index: 30;
            transition: right 0.3s ease;
            box-shadow: -5px 0 30px rgba(0,0,0,0.05);
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open { right: 0; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; margin-bottom: 5px; color: #666; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; -webkit-appearance: none;}

        .btn {
            background: var(--text-main);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--text-main);
            color: var(--text-main);
        }

        /* å†å²è®°å½•åˆ—è¡¨ */
        #history-list { flex: 1; overflow-y: auto; margin-top: 20px; -webkit-overflow-scrolling: touch; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; }

        /* åˆ›æ„ç”Ÿæˆç»“æœå¼¹çª— */
        #idea-modal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 85%;
            max-height: 80%;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            padding: 25px;
            overflow-y: auto;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        #idea-modal.open {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        #idea-content { line-height: 1.6; font-size: 14px; }
        #close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; padding: 10px; cursor: pointer;}

        /* åº•éƒ¨æ“ä½œæ  */
        #bottom-actions {
            position: absolute;
            bottom: 90px; /* åœ¨è¾“å…¥æ¡†ä¸Šé¢ */
            bottom: calc(90px + env(safe-area-inset-bottom));
            right: 20px;
            z-index: 9;
        }
        
        #bottom-actions button {
            padding: 8px 16px;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* D3 èŠ‚ç‚¹æ ·å¼ */
        .node circle {
            stroke: #ddd;
            stroke-width: 1.5px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .node.selected circle, .node.root circle {
            fill: var(--accent-color) !important;
            stroke: #000 !important;
            r: 50 !important;
        }
        
        .node.loading circle {
            stroke: var(--accent-color);
            stroke-width: 3px;
            animation: breathe 1.5s infinite;
        }

        @keyframes breathe {
            0% { stroke-opacity: 1; stroke-width: 2px; }
            50% { stroke-opacity: 0.4; stroke-width: 8px; }
            100% { stroke-opacity: 1; stroke-width: 2px; }
        }

        /* æ–‡æœ¬å®¹å™¨ */
        .foreign-obj { pointer-events: none; }
        .word-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
            line-height: 1.2;
            padding: 2px;
            box-sizing: border-box;
        }
        .main-word { font-weight: bold; font-size: 14px; color: #000; overflow-wrap: break-word; max-width: 90%;}
        .sub-word { font-size: 10px; color: #444; margin-top: 2px; overflow-wrap: break-word; max-width: 95%;}

    </style>
</head>
<body>

    <!-- åŠ è½½é®ç½© -->
    <div id="loading-screen">èµ„æºåŠ è½½ä¸­...</div>

    <!-- ç”»å¸ƒ -->
    <div id="viz-container"></div>

    <!-- å³ä¸Šè§’æŒ‰é’® -->
    <div class="top-right-controls">
        <div class="icon-btn glass" onclick="toggleSettings()" title="è®¾ç½®API">âš™ï¸</div>
        <div class="icon-btn glass" onclick="toggleHistory()" title="å†å²è®°å½•">ğŸ“œ</div>
    </div>

    <!-- è¾“å…¥æ¡† -->
    <div id="input-wrapper" class="glass">
        <input type="text" id="main-input" placeholder="è¾“å…¥çµæ„Ÿè¯ï¼Œå›è½¦å‘æ•£..." autocomplete="off">
    </div>

    <!-- åº•éƒ¨åŠŸèƒ½æŒ‰é’® -->
    <div id="bottom-actions">
        <button class="btn glass" onclick="generateIdeaScheme()">âœ¨ ç”Ÿæˆåˆ›æ„</button>
    </div>

    <!-- ä¾§è¾¹æ ï¼šè®¾ç½® -->
    <div id="settings-sidebar" class="sidebar">
        <h3>API è®¾ç½®</h3>
        <div class="form-group">
            <label>API Key</label>
            <input type="password" id="api-key" placeholder="Enter Gemini API Key">
        </div>
        <div class="form-group">
            <label>æ¨¡å‹åç§°</label>
            <input type="text" id="model-name" value="gemini-1.5-flash">
        </div>
        <div class="form-group">
            <label>API Endpoint (å¯é€‰)</label>
            <input type="text" id="api-url" placeholder="å®˜æ–¹é»˜è®¤åœ°å€">
        </div>
        <button class="btn" onclick="validateApi()">éªŒè¯æœ‰æ•ˆæ€§</button>
        <p id="api-status" style="font-size:12px; margin-top:5px; height: 20px;"></p>
        <button class="btn btn-outline" style="margin-top:auto;" onclick="toggleSettings()">å…³é—­</button>
    </div>

    <!-- ä¾§è¾¹æ ï¼šå†å²è®°å½• -->
    <div id="history-sidebar" class="sidebar">
        <h3>å†å²è®°å½•</h3>
        <div id="history-list"></div>
        <button class="btn btn-outline" style="margin-top:auto;" onclick="toggleHistory()">å…³é—­</button>
    </div>

    <!-- åˆ›æ„æ–¹æ¡ˆå¼¹çª— -->
    <div id="idea-modal" class="glass">
        <div id="close-modal" onclick="closeIdeaModal()">Ã—</div>
        <h2 style="margin-top:0; font-size: 18px;">ğŸ’¡ åˆ›æ„æ–¹æ¡ˆ</h2>
        <div id="idea-content"></div>
    </div>

    <script>
        // 0. å…¨å±€çŠ¶æ€ (å¿…é¡»æœ€å…ˆå®šä¹‰)
        const state = {
            nodes: [],
            links: [],
            selectedNodes: new Set(),
            history: [],
            isFirstInput: true,
            apiConfig: {
                key: localStorage.getItem('gemini_key') || '',
                model: localStorage.getItem('gemini_model') || 'gemini-1.5-flash',
                url: localStorage.getItem('gemini_url') || 'https://generativelanguage.googleapis.com/v1beta/models/'
            }
        };

        // ç§»é™¤åŠ è½½é®ç½©
        window.onload = () => {
            const loader = document.getElementById('loading-screen');
            loader.style.opacity = '0';
            setTimeout(() => loader.remove(), 500);
            initApp();
        };

        function initApp() {
            // UI åˆå§‹åŒ–
            const keyInput = document.getElementById('api-key');
            const modelInput = document.getElementById('model-name');
            const urlInput = document.getElementById('api-url');
            
            if(keyInput) keyInput.value = state.apiConfig.key;
            if(modelInput) modelInput.value = state.apiConfig.model;
            if(urlInput && state.apiConfig.url) urlInput.value = state.apiConfig.url;
            
            document.getElementById('main-input').focus();
            
            // åˆå§‹åŒ– D3
            initD3();
        }

        // D3 å˜é‡
        let svg, simulation, g, link, node;
        let width, height;

        function initD3() {
            width = window.innerWidth;
            height = window.innerHeight;
            
            svg = d3.select("#viz-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .on("click", (e) => {
                    // ç‚¹å‡»ç©ºç™½å¤„å–æ¶ˆé€‰æ‹©
                    if(e.target.tagName === 'svg') {
                        state.selectedNodes.clear();
                        updateNodeStyles();
                        document.getElementById('main-input').blur(); // ç§»åŠ¨ç«¯æ”¶èµ·é”®ç›˜
                    }
                });

            // åŠ›å¯¼å‘å›¾é…ç½®
            simulation = d3.forceSimulation(state.nodes)
                .force("link", d3.forceLink(state.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2 - 50))
                .force("collide", d3.forceCollide(55).iterations(2))
                .alphaDecay(0.04)
                .velocityDecay(0.6);

            g = svg.append("g");
            
            // ç¼©æ”¾
            const zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on("zoom", (event) => g.attr("transform", event.transform));
            svg.call(zoom);

            // åˆå§‹åŒ–é€‰æ‹©é›†
            link = g.append("g").attr("class", "links").selectAll(".link");
            node = g.append("g").attr("class", "nodes").selectAll(".node");

            // ç›‘å¬çª—å£å¤§å°å˜åŒ– (æ—‹è½¬å±å¹•/è½¯é”®ç›˜å¼¹å‡º)
            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;
                svg.attr("width", width).attr("height", height);
                simulation.force("center", d3.forceCenter(width / 2, height / 2 - 50));
                simulation.alpha(0.3).restart();
            });
        }

        function render() {
            // æ›´æ–°æ•°æ®
            link = link.data(state.links, d => d.source.id + "-" + d.target.id);
            link.exit().remove();
            const linkEnter = link.enter().append("line").attr("class", "link")
                .style("stroke", "#999").style("stroke-opacity", 0.3).style("stroke-width", 1.5);
            link = linkEnter.merge(link);

            node = node.data(state.nodes, d => d.id);
            node.exit().transition().duration(300).attr("transform", d => `translate(${d.x},${d.y}) scale(0)`).remove();

            const nodeEnter = node.enter().append("g")
                .attr("class", d => `node ${d.isRoot ? 'root' : ''}`)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("click", handleNodeClick) // å·¦é”®/å•å‡»
                .on("contextmenu", handleNodeContext) // å³é”®
                .on("touchstart", handleTouchStart) // ç§»åŠ¨ç«¯é•¿æŒ‰æ¨¡æ‹Ÿ
                .on("touchend", handleTouchEnd);

            nodeEnter.append("circle")
                .attr("r", 0)
                .attr("fill", "#fff")
                .transition().duration(500)
                .attr("r", d => d.isRoot ? 50 : 35);

            const fo = nodeEnter.append("foreignObject")
                .attr("width", d => d.isRoot ? 100 : 70)
                .attr("height", d => d.isRoot ? 100 : 70)
                .attr("x", d => d.isRoot ? -50 : -35)
                .attr("y", d => d.isRoot ? -50 : -35)
                .attr("class", "foreign-obj");

            fo.append("xhtml:div")
                .attr("class", "word-container")
                .html(d => `<div class="main-word">${d.word}</div><div class="sub-word">${d.trans}</div>`);

            node = nodeEnter.merge(node);
            updateNodeStyles();
            
            simulation.nodes(state.nodes).on("tick", ticked);
            simulation.force("link").links(state.links);
            simulation.alpha(0.5).restart();
        }

        function ticked() {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        }

        function updateNodeStyles() {
            node.classed("selected", d => state.selectedNodes.has(d.id));
            node.select("circle").transition().duration(300)
                .attr("r", d => d.isRoot ? 50 : (state.selectedNodes.has(d.id) ? 45 : 35));
        }

        // äº¤äº’ï¼šé•¿æŒ‰é€»è¾‘ (ç§»åŠ¨ç«¯æ¨¡æ‹Ÿå³é”®)
        let touchTimer = null;
        let isLongPress = false;

        function handleTouchStart(event, d) {
            isLongPress = false;
            touchTimer = setTimeout(() => {
                isLongPress = true;
                // è§¦å‘é€‰ä¸­é€»è¾‘
                toggleSelection(d);
                // éœ‡åŠ¨åé¦ˆ
                if(navigator.vibrate) navigator.vibrate(50);
            }, 600); // é•¿æŒ‰600msç®—é€‰ä¸­
        }

        function handleTouchEnd() {
            if (touchTimer) clearTimeout(touchTimer);
        }

        function handleNodeClick(event, d) {
            if (isLongPress) return; // å¦‚æœæ˜¯é•¿æŒ‰è§¦å‘çš„ï¼Œå¿½ç•¥ç‚¹å‡»
            if (event.defaultPrevented) return; // æ‹–æ‹½ä¸è§¦å‘
            
            // ç‚¹å‡»æ‰©æ•£
            const element = d3.select(this);
            element.classed("loading", true);
            
            fetchGeminiAssociations(d.word)
                .then(newWords => addChildrenNodes(d, newWords))
                .catch(err => alert("API Error: " + err.message))
                .finally(() => element.classed("loading", false));
        }

        function handleNodeContext(event, d) {
            event.preventDefault();
            toggleSelection(d);
        }

        function toggleSelection(d) {
            if (state.selectedNodes.has(d.id)) state.selectedNodes.delete(d.id);
            else state.selectedNodes.add(d.id);
            updateNodeStyles();
        }

        // æ‹–æ‹½
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x; d.fy = d.y;
        }
        function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null; d.fy = null;
        }

        // è¾“å…¥å¤„ç†
        const inputEl = document.getElementById('main-input');
        inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && inputEl.value.trim() !== "") {
                processInput(inputEl.value.trim());
                inputEl.value = "";
                inputEl.blur(); // ç§»åŠ¨ç«¯å›è½¦åæ”¶èµ·é”®ç›˜
            }
        });

        async function processInput(text) {
            if (state.isFirstInput) {
                document.getElementById('input-wrapper').classList.add('active');
                state.isFirstInput = false;
                
                const rootNode = { id: text, word: text, trans: "SEED", isRoot: true, x: width/2, y: height/2 };
                state.nodes.push(rootNode);
                render();
                addToHistory(text);

                // é¦–æ¬¡è‡ªåŠ¨è”æƒ³
                setTimeout(() => {
                    const rootEl = node.filter(d => d.id === text).node();
                    if(rootEl) d3.select(rootEl).classed("loading", true);
                    
                    fetchGeminiAssociations(text).then(words => {
                        addChildrenNodes(rootNode, words);
                        if(rootEl) d3.select(rootEl).classed("loading", false);
                    });
                }, 100);
            } else {
                // è¿æ¥åˆ°é€‰ä¸­è¯
                let parentNode = null;
                if (state.selectedNodes.size > 0) {
                    const lastId = Array.from(state.selectedNodes).pop();
                    parentNode = state.nodes.find(n => n.id === lastId);
                }

                const newNodeId = text + "_" + Date.now();
                const newNode = { 
                    id: newNodeId, word: text, trans: "Input", 
                    x: parentNode ? parentNode.x + (Math.random()-0.5)*50 : width/2, 
                    y: parentNode ? parentNode.y + (Math.random()-0.5)*50 : height/2 
                };
                
                state.nodes.push(newNode);
                if (parentNode) state.links.push({ source: parentNode.id, target: newNodeId });
                render();
            }
        }

        function addChildrenNodes(parentNode, wordsData) {
            if(!wordsData) return;
            wordsData.forEach((item, i) => {
                const nodeId = item.word;
                if (state.nodes.find(n => n.id === nodeId)) return;
                const newNode = {
                    id: nodeId, word: item.word, trans: item.trans,
                    x: parentNode.x + Math.cos(i) * 60, y: parentNode.y + Math.sin(i) * 60
                };
                state.nodes.push(newNode);
                state.links.push({ source: parentNode.id, target: nodeId });
            });
            render();
        }

        // API é€»è¾‘
        async function fetchGeminiAssociations(word) {
            const config = state.apiConfig;
            if (!config.key) throw new Error("è¯·å…ˆè®¾ç½® API Key");

            const prompt = `ä½ æ˜¯ä¸€ä¸ªåˆ›æ„è”æƒ³åŠ©æ‰‹ã€‚è¯·æ ¹æ®è¯è¯­â€œ${word}â€ï¼Œå‘æ•£å‡º7åˆ°8ä¸ªç›¸å…³çš„ã€æœ‰åˆ›æ„çš„å…³è”è¯ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§JSONæ•°ç»„æ ¼å¼è¿”å›: [{"word": "ä¸­æ–‡", "trans": "En"}].`;
            const url = `${config.url}${config.model}:generateContent?key=${config.key}`;

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if(!res.ok) throw new Error("è¯·æ±‚å¤±è´¥");
            const data = await res.json();
            let text = data.candidates[0].content.parts[0].text;
            text = text.replace(/```json|```/g, '').trim();
            return JSON.parse(text);
        }

        async function generateIdeaScheme() {
            if (state.selectedNodes.size === 0) return alert("è¯·å…ˆé•¿æŒ‰é€‰ä¸­è¯è¯­ï¼");
            
            const words = Array.from(state.selectedNodes).map(id => {
                const n = state.nodes.find(node => node.id === id);
                return n ? n.word : id;
            }).join("ã€");

            const modal = document.getElementById('idea-modal');
            const content = document.getElementById('idea-content');
            modal.classList.add('open');
            content.innerHTML = '<div style="text-align:center; padding:30px;">æ­£åœ¨æ€è€ƒåˆ›æ„...ğŸ§ </div>';

            try {
                const config = state.apiConfig;
                const prompt = `æˆ‘é€‰æ‹©äº†ä¸€äº›çµæ„Ÿè¯ï¼š${words}ã€‚è¯·åˆ©ç”¨è¿™äº›è¯ï¼Œç”Ÿæˆä¸€ä¸ªæœ‰åˆ›æ„çš„æ–¹æ¡ˆã€‚ä½¿ç”¨Markdownæ ¼å¼ã€‚`;
                const url = `${config.url}${config.model}:generateContent?key=${config.key}`;
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                content.innerHTML = marked.parse(text);
            } catch (e) {
                content.innerHTML = `<p style="color:red">ç”Ÿæˆå¤±è´¥: ${e.message}</p>`;
            }
        }

        // è®¾ç½®ä¸è¾…åŠ©åŠŸèƒ½
        function toggleSettings() {
            const el = document.getElementById('settings-sidebar');
            el.classList.toggle('open');
            if(!el.classList.contains('open')) saveSettings();
        }

        function saveSettings() {
            state.apiConfig.key = document.getElementById('api-key').value.trim();
            state.apiConfig.model = document.getElementById('model-name').value.trim();
            state.apiConfig.url = document.getElementById('api-url').value.trim() || state.apiConfig.url;
            localStorage.setItem('gemini_key', state.apiConfig.key);
            localStorage.setItem('gemini_model', state.apiConfig.model);
            localStorage.setItem('gemini_url', state.apiConfig.url);
        }

        async function validateApi() {
            saveSettings();
            const status = document.getElementById('api-status');
            if(!state.apiConfig.key) {
                status.textContent = "âŒ è¯·è¾“å…¥ API Key";
                return;
            }
            status.textContent = "â³ éªŒè¯ä¸­...";
            try {
                await fetchGeminiAssociations("Test");
                status.textContent = "âœ… éªŒè¯æˆåŠŸ";
                status.style.color = "green";
            } catch (e) {
                status.textContent = "âŒ å¤±è´¥: " + e.message;
                status.style.color = "red";
            }
        }

        function toggleHistory() { document.getElementById('history-sidebar').classList.toggle('open'); }
        function addToHistory(word) {
            state.history.push(word);
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerText = word;
            div.onclick = () => confirm("é‡æ–°å¼€å§‹ï¼Ÿ") && location.reload();
            document.getElementById('history-list').prepend(div);
        }
        function closeIdeaModal() { document.getElementById('idea-modal').classList.remove('open'); }

    </script>
</body>
</html>